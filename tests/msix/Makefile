# MSI-X Cocotb Testbench Makefile
#
# Copyright (c) 2025 Shareef Jalloq
# SPDX-License-Identifier: BSD-2-Clause

# Simulator selection
SIM ?= verilator
TOPLEVEL_LANG ?= verilog

# Source files - generated by Migen
VERILOG_SOURCES = $(shell pwd)/build/sim/tb_msix.v

# Top-level module name
TOPLEVEL = tb_msix

# Python test module
COCOTB_TEST_MODULES = test_msix

# Verilator-specific options
ifeq ($(SIM),verilator)
    EXTRA_ARGS += --trace --trace-fst --trace-structs
    EXTRA_ARGS += -Wno-WIDTHEXPAND -Wno-WIDTHTRUNC -Wno-INITIALDLY -Wno-COMBDLY -Wno-CASEINCOMPLETE
endif

# Include cocotb makefile
include $(shell cocotb-config --makefiles)/Makefile.sim

# Generate Verilog from Migen before running tests
$(VERILOG_SOURCES): tb_msix.py
	@echo "Generating Verilog from Migen..."
	@mkdir -p build/sim
	python tb_msix.py
	@# Copy memory init files to working directory for simulator
	@cp -f build/sim/*.init . 2>/dev/null || true

# Clean target
clean::
	rm -rf build/
	rm -rf __pycache__/
	rm -rf sim_build/
	rm -rf results.xml
	rm -rf *.fst
	rm -rf *.init
