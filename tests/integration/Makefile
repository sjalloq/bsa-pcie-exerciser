# Integration Tests Cocotb Makefile
#
# Copyright (c) 2025 Shareef Jalloq
# SPDX-License-Identifier: BSD-2-Clause

# Simulator selection
SIM ?= verilator
TOPLEVEL_LANG ?= verilog

# Source files - generated by Migen
VERILOG_SOURCES = $(shell pwd)/build/sim/tb_integration.v

# Top-level module name
TOPLEVEL = tb_integration

# Python test modules (comma-separated for cocotb)
# COCOTB_TEST_MODULES = test_registers
COCOTB_TEST_MODULES = test_registers,test_ats,test_monitor,test_intx

# Verilator-specific options
ifeq ($(SIM),verilator)
    EXTRA_ARGS += --trace --trace-fst --trace-structs
    EXTRA_ARGS += -Wno-WIDTHEXPAND -Wno-WIDTHTRUNC -Wno-INITIALDLY -Wno-COMBDLY -Wno-CASEINCOMPLETE
    EXTRA_ARGS += -Wno-UNOPTFLAT
endif

# Include cocotb makefile
include $(shell cocotb-config --makefiles)/Makefile.sim

# Generate Verilog from Migen before running tests
$(VERILOG_SOURCES): tb_integration.py
	@echo "Generating Verilog from Migen..."
	@mkdir -p build/sim
	python tb_integration.py
	@# Copy memory init files to working directory for simulator
	@cp -f build/sim/*.init . 2>/dev/null || true

# Clean target
clean::
	rm -rf build/
	rm -rf __pycache__/
	rm -rf sim_build/
	rm -rf results.xml
	rm -rf *.fst
	rm -rf *.init
